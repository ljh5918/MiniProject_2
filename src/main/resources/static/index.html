<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MovieSense - ë‚˜ë§Œì˜ ì˜í™” íë ˆì´í„°</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

<header>
    <div class="logo" onclick="location.reload()">ğŸ¬ MovieSense</div>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="ì˜í™” ì œëª© ê²€ìƒ‰...">
        <button onclick="searchMovies()">ğŸ”</button>
    </div>

    <div class="auth-buttons">
        <!-- ğŸ”¹ ë¹„ë¡œê·¸ì¸ UI -->
        <div id="guestNav">
            <a href="/login.html"><button class="btn-login">ë¡œê·¸ì¸</button></a>
            <a href="/register.html"><button class="btn-signup">íšŒì›ê°€ì…</button></a>
        </div>

        <!-- ğŸ”¹ ë¡œê·¸ì¸ UI -->
        <div id="userNav" style="display: none;">
            <span id="welcomeMsg">í™˜ì˜í•©ë‹ˆë‹¤!</span>
            <button class="btn-mypage" onclick="location.href='/board.html'">â­ ê²Œì‹œíŒ</button>
            <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</header>


<main>
    <!-- ğŸ”¹ ë¡œê·¸ì¸ ì‚¬ìš©ì ì¶”ì²œ -->
    <section id="personalSection" style="display: none;">
        <h2>âœ¨ <span id="userName">User</span>ë‹˜ ì·¨í–¥ ì €ê²© ì˜í™”</h2>
        <div id="personalContainer" class="movie-grid"></div>
        <hr class="divider">
    </section>

    <h2 id="sectionTitle">ğŸ”¥ ì‹¤ì‹œê°„ ì¸ê¸° ì˜í™”</h2>
    <div id="movieContainer" class="movie-grid"></div>
</main>

<!-- ğŸ”¹ ëª¨ë‹¬ -->
<div id="movieModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>

        <div class="modal-layout">
            <div class="modal-left">
                <img id="modalPoster" src="" alt="í¬ìŠ¤í„°">
            </div>

            <div class="modal-right">

                <div class="modal-header-info">
                    <h2 id="modalTitle">ì˜í™” ì œëª©</h2>
                    <button class="btn-like" onclick="toggleLike()">â¤ ì°œí•˜ê¸°</button>
                </div>

                <div class="modal-overview-box">
                    <h3>ì¤„ê±°ë¦¬</h3>
                    <p id="modalOverview">ì¤„ê±°ë¦¬ ë‚´ìš©...</p>
                </div>

                <div class="modal-recommend-box">
                    <h3>ğŸ’¡ ì´ ì˜í™”ì™€ ë¹„ìŠ·í•œ ì‘í’ˆ</h3>
                    <div id="recommendContainer" class="recommend-grid"></div>
                </div>

            </div>
        </div>
    </div>
</div>


<script src="/js/app.js"></script>

<!-- ğŸ”¥ JWT ë¡œê·¸ì¸ ìƒíƒœ ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ + ì˜í™” ë¡œë“œ
    window.onload = function () {
        checkLoginStatus();

        fetch('/test/popular')
            .then(res => res.json())
            .then(data => renderMovies(data, 'movieContainer'));
    };

    // ğŸ”¹ JWT ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    async function checkLoginStatus() {
        try {
            const res = await fetch("/user/me", {   // â† ìˆ˜ì •ë¨ (/auth/me â†’ /user/me)
                method: "GET",
                credentials: "include"
            });

            if (!res.ok) {
                return showGuestNav();
            }

            const user = await res.json();
            showUserNav(user);

        } catch (e) {
            console.error(e);
            showGuestNav();
        }
    }

    // ğŸ”¹ ë¡œê·¸ì¸ ìƒíƒœ UI ì ìš©
    function showUserNav(user) {
        document.getElementById("guestNav").style.display = "none";
        document.getElementById("userNav").style.display = "block";

        document.getElementById("personalSection").style.display = "block";
        document.getElementById("userName").innerText = user.name || user.email;

        // ì¶”ì²œ ì˜í™” ë¡œë“œ
        fetch('/test/popular')
            .then(res => res.json())
            .then(data => renderMovies(data.slice(5, 10), 'personalContainer'));
    }

    // ğŸ”¹ ë¹„ë¡œê·¸ì¸ UI
    function showGuestNav() {
        document.getElementById("guestNav").style.display = "block";
        document.getElementById("userNav").style.display = "none";
        document.getElementById("personalSection").style.display = "none";
    }

    // ğŸ”¹ ë¡œê·¸ì•„ì›ƒ
    async function logout() {
        await fetch("/user/logout", {
            method: "POST",
            credentials: "include"
        });

        alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
        location.reload();
    }
</script>


</body>
</html>

