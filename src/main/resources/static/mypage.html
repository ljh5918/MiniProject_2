<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€ - MovieSense</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
    <div class="logo" onclick="location.href='/'">ğŸ¬ MovieSense</div>
    <div class="auth-buttons">
        <div id="guestNav" style="display: none;">
            <a href="/login.html"><button>ë¡œê·¸ì¸</button></a>
        </div>
        <div id="userNav" style="display: none;">
            <span id="welcomeMsg"></span>
            <button onclick="location.href='/'">ë©”ì¸ìœ¼ë¡œ</button>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</header>

<main>
    <h2>â­ ë‚´ê°€ ì°œí•œ ì˜í™”</h2>
    <div id="favoritesContainer" class="movie-grid"></div>
</main>

<script>
const IMAGE_BASE_URL = "https://image.tmdb.org/t/p/w500";
const NO_POSTER_URL = "https://placehold.co/300x450/000000/ffffff?text=No+Poster";

// í˜ì´ì§€ ë¡œë“œ ì‹œ
window.onload = function() {
    checkLoginStatus();
};

// ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
async function checkLoginStatus() {
    try {
        const res = await fetch("/user/me", { method: "GET", credentials: "include" });
        if (!res.ok) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/login.html";
            return;
        }
        const user = await res.json();
        document.getElementById("userNav").style.display = "block";
        document.getElementById("welcomeMsg").innerText = `${user.nickname}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!`;

        // ì°œí•œ ì˜í™” ë¡œë“œ
        loadFavorites();
    } catch (err) {
        console.error(err);
        alert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        location.href = "/login.html";
    }
}

// ì°œí•œ ì˜í™” ê°€ì ¸ì˜¤ê¸°
async function loadFavorites() {
    try {
        const res = await fetch("/favorite/list", { method: "GET", credentials: "include" });
        const movies = await res.json();
        renderMovies(movies, 'favoritesContainer');
    } catch (err) {
        console.error(err);
        document.getElementById('favoritesContainer').innerHTML = '<p>ì°œí•œ ì˜í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
}

// ì˜í™” ë Œë”ë§
function renderMovies(movies, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    if (!movies || movies.length === 0) {
        container.innerHTML = '<p>ì°œí•œ ì˜í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    movies.forEach(movie => {
        const posterSrc = movie.posterPath ? IMAGE_BASE_URL + movie.posterPath : NO_POSTER_URL;
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.innerHTML = `
            <img src="${posterSrc}" alt="${movie.title}">
            <h3>${movie.title}</h3>
        `;
        container.appendChild(card);
    });
}

// ë¡œê·¸ì•„ì›ƒ
async function logout() {
    await fetch("/user/logout", { method: "POST", credentials: "include" });
    alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
    location.href = "/login.html";
}
</script>
</body>
</html>
